name: Build and Deploy (Production)

on:
  workflow_dispatch:
  push:
    branches:
      - main
      - master
      - force-production

jobs:
  audit:
    runs-on: ubuntu-latest
    environment: production
    strategy:
      fail-fast: true
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v3
        with:
          version: 10.15.1

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: pnpm

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Run security audit
        run: |
          echo "Running pnpm audit..."
          pnpm audit --audit-level moderate || {
            echo "Security vulnerabilities found!"
            echo "Please review and fix the issues above before proceeding."
            exit 1
          }
          echo "No security vulnerabilities found."

      - name: Check for outdated packages
        run: |
          echo "Checking for outdated packages..."
          pnpm outdated || echo "Some packages are outdated, but this is not blocking the build."

      - name: Verify package integrity
        run: |
          echo "Verifying package integrity..."
          pnpm list --depth=0 --json > /dev/null || {
            echo "Package integrity check failed!"
            exit 1
          }
          echo "Package integrity verified successfully."

  build-app:
    runs-on: ubuntu-latest
    environment: production
    needs: [audit]
    strategy:
      fail-fast: true
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build Docker image
        run: |
          docker build . -t vetrii-backend-production:latest --target production --cache-from=type=gha --cache-to=type=gha,mode=max
          docker save vetrii-backend-production:latest > image.tar

      - name: Copy Docker image to Server
        uses: appleboy/scp-action@master
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USERNAME }}
          key: ${{ secrets.SERVER_SSH_KEY }}
          source: "image.tar"
          target: "/http/vetrii-api.vetriilab.com/docker-build"
          overwrite: true

  deploy-and-notify:
    runs-on: ubuntu-latest
    environment: production
    needs: [build-app]
    steps:
      - name: Trigger deployment on Server and wait
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USERNAME }}
          key: ${{ secrets.SERVER_SSH_KEY }}
          command_timeout: 3m
          script: |
            cd /http/vetrii-api.com/docker-build
            rm -f .output*
            touch .deploy_production

            while [ ! -f .output_code ]; do
                sleep 1
            done

            cat .output
            exit $(cat .output_code)

      - name: Discord Webhook Action
        uses: tsickert/discord-webhook@v5.3.0
        with:
          webhook-url: ${{ secrets.VETRII_DISCORD_WEBHOOK_URL }}
          content: "Vetrii backend deployed to production"
